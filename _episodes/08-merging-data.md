---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 08-merging-data.md in _episodes_rmd/
title: "Merging and Joining Data"
keypoints:
- Use `merge()` to stack data
- Use `merge()` to join data
- Understand joins
objectives:
- Learn how to stack data frames (ex. different years' data)
- Learn how to join - inner, outer, etc.
- Explore after a join to verify results as expected
questions: How can I combine data from different sources?
source: Rmd
teaching: 45
exercises: 10
---



## Introduction goes here

Text


~~~
library(SASxport)
library(tidyverse)
~~~
{: .language-r}



~~~
── Attaching packages ───────────────────────────────────────────────────── tidyverse 1.2.1 ──
~~~
{: .output}



~~~
✔ ggplot2 3.2.1     ✔ purrr   0.3.2
✔ tibble  2.1.3     ✔ dplyr   0.8.3
✔ tidyr   0.8.3     ✔ stringr 1.4.0
✔ readr   1.3.1     ✔ forcats 0.4.0
~~~
{: .output}



~~~
── Conflicts ──────────────────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
~~~
{: .output}


~~~
demographics <- read.xport('data/DEMO_I.XPT')
bmi_df <- read.xport('data/BMX_I.XPT') 
bp_df <- read.xport('data/BPX_I.XPT')
cbc_df <- read.xport('data/CBC_I.XPT')
glu_df <- read.xport('data/GLU_I.XPT')
tg_df <- read.xport('data/TRIGLY_I.XPT')
hdl_df <- read.xport('data/HDL_I.XPT')
tc_df <- read.xport('data/TCHOL_I.XPT')
# smk_df <- read.xport('data/SMQ_I.XPT')
~~~
{: .language-r}

Now that we have all the files read in, let's merge.
From bmi_df we are keeping: BMXBMI
from bp_df: PBXPLS (pules), BPXSY1 (SBP), PBXDI1 (DPB),
tg_df : LBXTR (triglycerides mg/dL), LBDLDL (LDL mg/dL)
tc_df: LBXTC (total chol mg/dL)
hdl_df: LBDHDD (HDL mg/dL)
cbc_df: LBXWBCSI (WBCs 1000cells/uL)
glu_df: LBXGLU (glucose fasting mg/dL)

HERE WE NEED TO CONSIDER DPLYR FOR JOINING. #TODO


~~~
merge_df <- merge(demographics, bmi_df[ ,c("SEQN", "BMXBMI")])
merge_df <- merge (merge_df, bp_df[ ,c("SEQN", "BPXSY1", "BPXDI1")])
merge_df <- merge(merge_df, tg_df[ , c("SEQN", "LBXTR", "LBDLDL")])
merge_df <- merge(merge_df, tc_df[ , c("SEQN", "LBXTC")])
merge_df <- merge(merge_df, hdl_df[ , c("SEQN", "LBDHDD")])
merge_df <- merge(merge_df, cbc_df[ , c("SEQN", "LBXWBCSI")])
merge_df <- merge(merge_df, glu_df[ , c("SEQN", "LBXGLU")])
~~~
{: .language-r}


~~~
write.csv(merge_df, file = 'data_out/merge.csv', row.names = FALSE)
~~~
{: .language-r}


~~~
merge_df <- read.csv("data_out/merge.csv")
~~~
{: .language-r}

Variables of interest:
BMI, BP, LDL, TC, HDL, GLU, AGE,
-We are interested in the association between TC and BMI categories. (Total chol (TC) = outcome and glucose (main predictor))

1. After merging, first look at NAs and summaries of variables.

~~~
# Look at descriptive statistics of all independent variables

summary(merge_df$LBXTC) # total chol --> outcome variable.
~~~
{: .language-r}



~~~
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   80.0   153.0   181.0   184.2   209.0   545.0     238 
~~~
{: .output}



~~~
sd(merge_df$LBXTC, na.rm = TRUE) # gives standard deviation; removes na values (na.rm=TRUE)
~~~
{: .language-r}



~~~
[1] 42.85437
~~~
{: .output}



~~~
summary(merge_df$LBXGLU) # glucose
~~~
{: .language-r}



~~~
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   21.0    94.0   101.0   110.6   111.0   479.0     219 
~~~
{: .output}



~~~
summary(merge_df$BMXBMI) # BMI
~~~
{: .language-r}



~~~
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  14.10   23.40   27.50   28.49   32.30   64.50      37 
~~~
{: .output}



~~~
summary(merge_df$RIDAGEYR) #TODO exclude people <18yo now. 
~~~
{: .language-r}



~~~
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  12.00   25.00   43.00   43.81   61.00   80.00 
~~~
{: .output}

2. Next, let's look at these variables in detail with graphs:

~~~
hist(merge_df$LBXTC, breaks = 30, xlab = "Total cholesterol (TC) (mg/dl)",  main = "Distribution of Total Cholesterol") # looks normal overall
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-8-1.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

~~~
hist(merge_df$LBXGLU, breaks = 100) # right skewed
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-8-2.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

~~~
boxplot(merge_df$LBXGLU) # looking at outliers of IV
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-8-3.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

~~~
hist(merge_df$BMXBMI, breaks = 50) # slightly right skewed
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-8-4.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

~~~
boxplot(merge_df$BMXBMI) # looking at outliers of IV
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-8-5.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

~~~
hist(merge_df$RIDAGEYR, breaks = 50) # if you ignore >=80 category and <=10, it's normal looking. 
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-8-6.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

~~~
#TODO Create histograms etc of Blood pressure variables here (for continuous)
~~~
{: .language-r}

3. Let's drop anyone under the age of 25 b/c changes in TC may not be apparent in the younger age groups. 

~~~
merge25_df <- merge_df %>% filter((RIDAGEYR>=25 & RIDAGEYR<80)) #& LBXGLU<=200)
boxplot(merge25_df$LBXGLU) # looking at outliers again in this new dataset
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-9-1.png" title="plot of chunk unnamed-chunk-9" alt="plot of chunk unnamed-chunk-9" width="612" style="display: block; margin: auto;" />

~~~
boxplot(merge25_df$BMXBMI) # looking at outliers again
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-9-2.png" title="plot of chunk unnamed-chunk-9" alt="plot of chunk unnamed-chunk-9" width="612" style="display: block; margin: auto;" />

4.Let's do scatter plots to see linear relationship between predictors and outcome variable:

~~~
scatter.smooth(merge25_df$LBXGLU, merge25_df$LBXTC, xlab = "Glucose levels (mg/dl)", ylab = "Total Cholesterol (mg/dl)")
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-10-1.png" title="plot of chunk unnamed-chunk-10" alt="plot of chunk unnamed-chunk-10" width="612" style="display: block; margin: auto;" />

~~~
scatter.smooth(merge25_df$BMXBMI, merge25_df$LBXTC, xlab = "BMI", ylab = "Total Cholesterol (mg/dl)")
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-10-2.png" title="plot of chunk unnamed-chunk-10" alt="plot of chunk unnamed-chunk-10" width="612" style="display: block; margin: auto;" />

~~~
scatter.smooth(merge25_df$RIDAGEYR, merge25_df$LBXTC, xlab = "Age (years)", ylab = "Total Cholesterol (mg/dl)")
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-10-3.png" title="plot of chunk unnamed-chunk-10" alt="plot of chunk unnamed-chunk-10" width="612" style="display: block; margin: auto;" />

~~~
scatter.smooth(merge25_df$LBDHDD, merge25_df$LBXTC, xlab = "HDL", ylab = "Total Cholesterol (mg/dl)")
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-10-4.png" title="plot of chunk unnamed-chunk-10" alt="plot of chunk unnamed-chunk-10" width="612" style="display: block; margin: auto;" />

~~~
scatter.smooth(merge25_df$LBDLDL, merge25_df$LBXTC, xlab = "LDL", ylab = "Total Cholesterol (mg/dl)")
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-10-5.png" title="plot of chunk unnamed-chunk-10" alt="plot of chunk unnamed-chunk-10" width="612" style="display: block; margin: auto;" />

5. Let's do a correlation matrix now

~~~
cor(merge25_df[ , c("LBXGLU", "BMXBMI", "RIDAGEYR", "LBDHDD", "LBDLDL")], use = "complete.obs") # everything looks like below 27% multicollinearity.
~~~
{: .language-r}



~~~
              LBXGLU      BMXBMI    RIDAGEYR      LBDHDD      LBDLDL
LBXGLU    1.00000000  0.16705420  0.18523715 -0.18053407  0.04221152
BMXBMI    0.16705420  1.00000000  0.04706262 -0.28242817  0.04512733
RIDAGEYR  0.18523715  0.04706262  1.00000000  0.05690830 -0.01627925
LBDHDD   -0.18053407 -0.28242817  0.05690830  1.00000000 -0.09626362
LBDLDL    0.04221152  0.04512733 -0.01627925 -0.09626362  1.00000000
~~~
{: .output}

BLOOD PRESSURE CATEGORIES:
https://www.heart.org/-/media/data-import/downloadables/pe-abh-what-is-high-blood-pressure-ucm_300310.pdf

6. Let's create catgegories for variables we are intersted in.

~~~
bp_cat <- function(sbp, dbp) {
 if (is.na(sbp) | is.na(dbp)){
   return(NA)
 }
  #if (sbp>=180 | dbp >=120) {
   # return("Hypertensive Crisis")
  #}
if (sbp>=140 | dbp >=90) {
    return("Hypertension Stage 2+")
  }

if ((sbp>=130 & sbp<=139) | (dbp >=80 & dbp <=89)) {
    return("Hypertension Stage 1")
  }

 if ((sbp>=120 & sbp<=129) &  dbp <80) {
    return("Elevated")
  }

  if (sbp < 120 & dbp <80) {
    return("Normal") 
  }
} 
~~~
{: .language-r}



~~~
# Converting Blood pressure into categories
# merge25_df <- merge25_df %>% mutate(bp_category = bp_cat(BPXSY1, BPXDI1))
merge25_df$bp_category <- mapply(bp_cat, merge25_df$BPXSY1, merge25_df$BPXDI1)
~~~
{: .language-r}

Let's first make sure that everything looks okay.  There are over 50 variables, so scrolling through the data frame in the viewer is not a great option.


~~~
# See what the range of text vales is
unique(merge25_df$bp_category)
~~~
{: .language-r}



~~~
[1] "Hypertension Stage 2+" "Hypertension Stage 1"  "Normal"               
[4] "Elevated"              NA                     
~~~
{: .output}



~~~
# Look at just the pertinent columns
just_bp <- merge25_df %>% select(BPXSY1, BPXDI1, bp_category) # check to make sure no NULL values and categories are correctly created
~~~
{: .language-r}


~~~
# Converting to factor 
merge25_df$bp_category <- as.factor(merge25_df$bp_category) 
merge25_df$bp_category <- relevel(merge25_df$bp_category, "Normal") #sets "normal" as reference.
str(merge25_df$bp_category)  # Observe that it's a factor
~~~
{: .language-r}



~~~
 Factor w/ 4 levels "Normal","Elevated",..: 4 3 1 1 1 2 3 3 3 1 ...
~~~
{: .output}



~~~
table(merge25_df$bp_category, useNA = "ifany")  # Inspect the values
~~~
{: .language-r}



~~~

               Normal              Elevated  Hypertension Stage 1 
                  825                   359                   482 
Hypertension Stage 2+                  <NA> 
                  448                   131 
~~~
{: .output}



~~~
barplot(table(merge25_df$bp_category)) #TODO reorder so it looks ordinal
~~~
{: .language-r}

<img src="../fig/rmd-01-unnamed-chunk-15-1.png" title="plot of chunk unnamed-chunk-15" alt="plot of chunk unnamed-chunk-15" width="612" style="display: block; margin: auto;" />


~~~
# Convert BMI into categories
merge25_df$BMI_category <- cut(merge25_df$BMXBMI, breaks = c(0, 18.5, 25.0, 30.0, 35.0, 40, 100), labels = c("Underweight", "Normal", "Pre-obese", "Obesity I", "Obesity II", "Obesity III"), right = FALSE)

merge25_df$BMI_category <- relevel(merge25_df$BMI_category, "Normal") #this sets "normal" as the reference category.

summary(merge25_df$BMI_category)
~~~
{: .language-r}



~~~
     Normal Underweight   Pre-obese   Obesity I  Obesity II Obesity III 
        564          30         716         480         244         187 
       NA's 
         24 
~~~
{: .output}

NOTE: lm ignoes NAs (check this again though).  Make a note of this in the write up of the lesson. 

7. Simple linear regression models:

~~~
#TODO: Set appropriate reference levels in factor variables (for BP and BMI)

# glucose
lm_gluc <- lm(LBXTC ~ LBXGLU, data = merge25_df) 
summary(lm_gluc)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ LBXGLU, data = merge25_df)

Residuals:
     Min       1Q   Median       3Q      Max 
-116.135  -29.713   -1.865   24.378  234.568 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 189.67106    2.62569  72.237   <2e-16 ***
LBXGLU        0.03042    0.02150   1.415    0.157    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 42 on 2109 degrees of freedom
  (134 observations deleted due to missingness)
Multiple R-squared:  0.0009479,	Adjusted R-squared:  0.0004742 
F-statistic: 2.001 on 1 and 2109 DF,  p-value: 0.1573
~~~
{: .output}



~~~
# bmi
lm_bmi <- lm(LBXTC ~ BMXBMI, data = merge25_df)
summary(lm_bmi)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ BMXBMI, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-114.24  -29.44   -2.30   23.57  351.37 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 196.9837     4.0465  48.680   <2e-16 ***
BMXBMI       -0.1214     0.1325  -0.916     0.36    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 42.67 on 2093 degrees of freedom
  (150 observations deleted due to missingness)
Multiple R-squared:  0.0004009,	Adjusted R-squared:  -7.673e-05 
F-statistic: 0.8393 on 1 and 2093 DF,  p-value: 0.3597
~~~
{: .output}



~~~
# bmi categorical
lm_bmicat <- lm(LBXTC ~ BMI_category, data = merge25_df)
summary(lm_bmicat)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ BMI_category, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-110.01  -29.15   -2.56   23.85  347.99 

Coefficients:
                        Estimate Std. Error t value Pr(>|t|)    
(Intercept)             190.0115     1.8589 102.219  < 2e-16 ***
BMI_categoryUnderweight  -5.8329     8.2535  -0.707  0.47982    
BMI_categoryPre-obese     6.9944     2.4695   2.832  0.00467 ** 
BMI_categoryObesity I     6.3129     2.7397   2.304  0.02131 *  
BMI_categoryObesity II    0.1381     3.3456   0.041  0.96707    
BMI_categoryObesity III  -2.4465     3.6993  -0.661  0.50847    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 42.55 on 2089 degrees of freedom
  (150 observations deleted due to missingness)
Multiple R-squared:  0.007771,	Adjusted R-squared:  0.005396 
F-statistic: 3.272 on 5 and 2089 DF,  p-value: 0.006014
~~~
{: .output}



~~~
# age
lm_age <- lm(LBXTC ~ RIDAGEYR, data = merge25_df)
summary(lm_age)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ RIDAGEYR, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-112.50  -29.56   -2.00   24.13  351.88 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 190.13344    3.26640  58.209   <2e-16 ***
RIDAGEYR      0.06225    0.06193   1.005    0.315    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 42.72 on 2111 degrees of freedom
  (132 observations deleted due to missingness)
Multiple R-squared:  0.0004784,	Adjusted R-squared:  4.925e-06 
F-statistic:  1.01 on 1 and 2111 DF,  p-value: 0.3149
~~~
{: .output}



~~~
# hdl
lm_hdl <- lm(LBXTC ~ LBDHDD, data = merge25_df)
summary(lm_hdl)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ LBDHDD, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-108.86  -29.68   -3.08   24.27  360.06 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 171.61577    2.98889  57.418  < 2e-16 ***
LBDHDD        0.39181    0.05145   7.616 3.93e-14 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 42.15 on 2111 degrees of freedom
  (132 observations deleted due to missingness)
Multiple R-squared:  0.02674,	Adjusted R-squared:  0.02628 
F-statistic:    58 on 1 and 2111 DF,  p-value: 3.925e-14
~~~
{: .output}



~~~
# ldl
lm_ldl <- lm(LBXTC ~ LBDLDL, data = merge25_df)
summary(lm_ldl)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ LBDLDL, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-43.374 -11.644  -2.058   9.076 159.757 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 72.18126    1.23227   58.58   <2e-16 ***
LBDLDL       1.04783    0.01026  102.17   <2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 16.37 on 1938 degrees of freedom
  (305 observations deleted due to missingness)
Multiple R-squared:  0.8434,	Adjusted R-squared:  0.8433 
F-statistic: 1.044e+04 on 1 and 1938 DF,  p-value: < 2.2e-16
~~~
{: .output}



~~~
# BP categorical
lm_bp <- lm(LBXTC ~ bp_category, data = merge25_df)
summary(lm_bp)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ bp_category, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-108.18  -28.18   -2.72   23.93  350.93 

Coefficients:
                                 Estimate Std. Error t value Pr(>|t|)    
(Intercept)                       187.288      1.514 123.718  < 2e-16 ***
bp_categoryElevated                 6.779      2.733   2.480   0.0132 *  
bp_categoryHypertension Stage 1     9.896      2.487   3.979 7.17e-05 ***
bp_categoryHypertension Stage 2+   11.081      2.557   4.333 1.55e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 42.14 on 1988 degrees of freedom
  (253 observations deleted due to missingness)
Multiple R-squared:  0.01278,	Adjusted R-squared:  0.01129 
F-statistic: 8.578 on 3 and 1988 DF,  p-value: 1.17e-05
~~~
{: .output}

#TODO  INTERACTION TERMS, look at literature to see which ones need to be created. 

Next: Just creating one big model just to see for now.

~~~
lm_model <- lm(LBXTC ~ LBXGLU + BMI_category + LBDHDD + LBDLDL + RIDAGEYR + bp_category, data = merge25_df)
summary(lm_model)
~~~
{: .language-r}



~~~

Call:
lm(formula = LBXTC ~ LBXGLU + BMI_category + LBDHDD + LBDLDL + 
    RIDAGEYR + bp_category, data = merge25_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-26.206  -7.420  -2.292   4.651  57.194 

Coefficients:
                                  Estimate Std. Error t value Pr(>|t|)    
(Intercept)                      22.562631   1.803854  12.508  < 2e-16 ***
LBXGLU                            0.031392   0.006605   4.753 2.16e-06 ***
BMI_categoryUnderweight           1.784421   2.504000   0.713 0.476168    
BMI_categoryPre-obese             2.414522   0.727692   3.318 0.000924 ***
BMI_categoryObesity I             2.127979   0.818348   2.600 0.009389 ** 
BMI_categoryObesity II            3.492399   0.997929   3.500 0.000477 ***
BMI_categoryObesity III           1.052192   1.108853   0.949 0.342797    
LBDHDD                            0.696874   0.016537  42.141  < 2e-16 ***
LBDLDL                            1.072123   0.007573 141.570  < 2e-16 ***
RIDAGEYR                          0.040554   0.019706   2.058 0.039734 *  
bp_categoryElevated               1.133793   0.796636   1.423 0.154843    
bp_categoryHypertension Stage 1   0.867193   0.733768   1.182 0.237426    
bp_categoryHypertension Stage 2+  2.151590   0.790372   2.722 0.006546 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 11.4 on 1812 degrees of freedom
  (420 observations deleted due to missingness)
Multiple R-squared:  0.9227,	Adjusted R-squared:  0.9222 
F-statistic:  1802 on 12 and 1812 DF,  p-value: < 2.2e-16
~~~
{: .output}


