---
title: "Merging and Joining Data"
teaching: 45
exercises: 10
questions:
- "How can I combine data from different sources?"
objectives:
- "Learn how to stack data frames (ex. different years' data)"
- "Learn how to join - inner, outer, etc."
- "Explore after a join to verify results as expected"
keypoints:
- "Use `merge()` to stack data"
- "Use `merge()` to join data"
- "Understand joins"
source: Rmd
---

```{r, include=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("01-")
```

## Introduction goes here

Text

```{r, eval=FALSE}
library(SASxport)
library(tidyverse)
```

```{r, eval=FALSE}
demographics <- read.xport('data/DEMO_I.XPT')
bmi_df <- read.xport('data/BMX_I.XPT') 
bp_df <- read.xport('data/BPX_I.XPT')
cbc_df <- read.xport('data/CBC_I.XPT')
glu_df <- read.xport('data/GLU_I.XPT')
tg_df <- read.xport('data/TRIGLY_I.XPT')
hdl_df <- read.xport('data/HDL_I.XPT')
tc_df <- read.xport('data/TCHOL_I.XPT')
# smk_df <- read.xport('data/SMQ_I.XPT')
```

Now that we have all the files read in, let's merge.
From bmi_df we are keeping: BMXBMI
from bp_df: PBXPLS (pules), BPXSY1 (SBP), PBXDI1 (DPB),
tg_df : LBXTR (triglycerides mg/dL), LBDLDL (LDL mg/dL)
tc_df: LBXTC (total chol mg/dL)
hdl_df: LBDHDD (HDL mg/dL)
cbc_df: LBXWBCSI (WBCs 1000cells/uL)
glu_df: LBXGLU (glucose fasting mg/dL)

HERE WE NEED TO CONSIDER DPLYR FOR JOINING. #TODO

```{r, eval=FALSE}
merge_df <- merge(demographics, bmi_df[ ,c("SEQN", "BMXBMI")])
merge_df <- merge (merge_df, bp_df[ ,c("SEQN", "BPXSY1", "BPXDI1")])
merge_df <- merge(merge_df, tg_df[ , c("SEQN", "LBXTR", "LBDLDL")])
merge_df <- merge(merge_df, tc_df[ , c("SEQN", "LBXTC")])
merge_df <- merge(merge_df, hdl_df[ , c("SEQN", "LBDHDD")])
merge_df <- merge(merge_df, cbc_df[ , c("SEQN", "LBXWBCSI")])
merge_df <- merge(merge_df, glu_df[ , c("SEQN", "LBXGLU")])
```

```{r, eval=FALSE}
write.csv(merge_df, file = 'data_out/merge.csv', row.names = FALSE)
```

Variables of interest:
BMI, BP, LDL, TC, HDL, GLU, AGE,
-We are interested in the association between TC and BMI categories. (Total chol (TC) = outcome and glucose (main predictor))

NOTE: lm ignoes NAs (check this again though).  Make a note of this in the write up of the lesson. 

BLOOD PRESSURE CATEGORIES:
https://www.heart.org/-/media/data-import/downloadables/pe-abh-what-is-high-blood-pressure-ucm_300310.pdf
 
```{r, eval=FALSE}
bp_cat <- function(sbp, dbp) {
 if (is.na(sbp) | is.na(dbp)){
   return(NA)
 }
  if (sbp>=180 | dbp >=120) {
    return("Hypertensive Crisis")
  }
if (sbp>=140 | dbp >=90) {
    return("Hypertension Stage 2")
  }

if ((sbp>=130 & sbp<=139) | (dbp >=80 & dbp <=89)) {
    return("Hypertension Stage 1")
  }

 if ((sbp>=120 & sbp<=129) &  dbp <80) {
    return("Elevated")
  }

  if (sbp < 120 & dbp <80) {
    return("Normal") 
  }
} 
```  
  
Analysis:
Linear Regression of outcome with each of variables of interest. 

```{r, eval=TRUE}
# Look at descriptive statistics of all independent variables
summary(merge_df$LBXTC) # total chol
summary(merge_df$LBXGLU) # glucose
summary(merge_df$BMXBMI) # BMI
summary(merge_df$RIDAGEYR) #TODO exclude people <18yo now. 
```


```{r, eval=FALSE}
# Converting Blood pressure into categories
# merge_df <- merge_df %>% mutate(bp_category = bp_cat(BPXSY1, BPXDI1))
merge_df$bp_category <- mapply(bp_cat, merge_df$BPXSY1, merge_df$BPXDI1)
merge_df %>% select(BPXSY1, BPXDI1, bp_category) # check to make sure no NULL values and categories are correctly created
```

```{r, eval=FALSE}
# Converting to factor 
merge_df$bp_category <- as.factor(merge_df$bp_category) 
str(merge_df$bp_category)
barplot(table(merge_df$bp_category)) #TODO reorder so it looks ordinal
```

```{r, eval=FALSE}
# Convert BMI into categories
merge_df$BMI_category <- cut(merge_df$BMXBMI, breaks = c(0, 18.5, 25.0, 30.0, 35.0, 40, 100), labels = c("Underweight", "Normal weight", "Pre-obese", "Obesity I", "Obesity II", "Obesity III"), right = FALSE)
summary(merge_df$BMI_category)
```




```{r, eval=FALSE}
lm_gluc <- lm(LBXTC ~ LBXGLU, data = merge_df) 
summary(lm_gluc)
lm_sbp <- lm(LBXTC ~ BPXSY1, data = merge_df)
summary(lm_sbp)
```

