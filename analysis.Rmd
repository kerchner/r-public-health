---
title: "Analysis"
output: pdf_document
---
#TODO:
table one
Do interaction terms
collinearity - vif? 
Model selection
Show model to predict

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
# install.packages('SASxport')
library(SASxport)
library(dplyr)
library(tidyr)
health_demo <- read.xport('data/health_demo.XPT')

health_lab <- read.csv('data/health_lab.csv')
```
# Merge

```{r}
colnames(health_demo)
```

```{r}
colnames(health_lab)
```

```{r}
health_df <- merge(health_demo, health_lab, by.x="STUDY.ID", by.y="STUDY_ID",
                   all.x=FALSE, all.y=TRUE)
```

```{r}
health_df$RACE <- as.factor(health_df$RACE)
levels(health_df$RACE) <- c('Mexican American', 'Other Hispanic', 'Non-Hispanic White', 'Non-Hispanic Black', 'Non-Hispanic Asian', 'Other Race - Including Multi-Racial')

health_df$GENDER <- as.factor(health_df$GENDER)
levels(health_df$GENDER) <- c('male', 'female')
```

# Exercise: Fix education level

# Renaming variables

```{r}
health_df <- rename(health_df, Marital_Status = MARITALS) 
```

# "Dropping"/Keeping variables

```{r}
analysis_df <- health_df %>% select(STUDY.ID, GENDER, AGE, RACE, BMI, SBP, DBP, Triglycerides, LDL, Tot_chol, HDL, WBC, FastGlucose)

str(analysis_df)
  
```

```{r}
summary(analysis_df)
```

```{r}
nrow(analysis_df)
```
Note that we have ages 12-81.
```{r}
analysis_df <- analysis_df %>% filter((AGE >= 25) & (AGE <= 75))
nrow(analysis_df)
```

Data cleaning: drop values <=0 for DBP
```{r}
analysis_df <- analysis_df %>% filter(DBP>0)
```

```{r}
summary(analysis_df)
```

 Note some extreme values that don't look right - data cleaning needed
 e.g. BMI = 61.70
 DBP = 0
 Triglycerides = 2141
 HDL = 226?
 WBC = 44.8 ?
 
 Note NAs

```{r}
hist(analysis_df$AGE)
```

```{r}
hist(analysis_df$AGE, breaks = 30)
```

```{r}
hist(analysis_df$BMI, breaks = 30) #slightly right skewed

hist(analysis_df$SBP, breaks = 30) # looks Normal
hist(analysis_df$DBP, breaks = 30) # looks Normal

hist((analysis_df$FastGlucose), breaks = 30) # go with log transformation instead. 
hist(log(analysis_df$FastGlucose), breaks = 30)

hist(analysis_df$Tot_chol, breaks = 30) #We see some values above 350ish in total chol.

hist(analysis_df$LDL, breaks = 30) # looks normal

hist(analysis_df$Triglycerides, breaks = 50) # NOT normal

hist(analysis_df$HDL, breaks = 30)

hist(analysis_df$WBC, breaks = 50) # some very high values
```

Relevel race: 
```{r}
analysis_df$RACE <- relevel(analysis_df$RACE, "Non-Hispanic White")
```

```{r drop_na}
analysis_df <- analysis_df %>% drop_na(SBP, DBP, AGE, BMI, HDL, FastGlucose, LDL, RACE)
```

```{r}
analysis_df$BMI_cat <- cut(analysis_df$BMI, breaks = c(0, 18.5, 25.0, 30.0, 35.0, 40, 100), labels = c("Underweight", "Normal", "Pre-obese", "Obesity I", "Obesity II", "Obesity III"), right = FALSE)

analysis_df$BMI_cat <- relevel(analysis_df$BMI_cat, "Normal") #this sets "normal" as the reference category.

summary(analysis_df$BMI_cat)
```
```{r create_new_var}
analysis_df$HDL_LDL <- (analysis_df$HDL/analysis_df$LDL)
```


BLOOD PRESSURE CATEGORIES:
https://www.heart.org/-/media/data-import/downloadables/pe-abh-what-is-high-blood-pressure-ucm_300310.pdf

6. Let's create catgegories for variables we are intersted in.
```{r, eval=TRUE}
bp_cat <- function(sbp, dbp) {
 if (is.na(sbp) | is.na(dbp)){
   return(NA)
 }
  #if (sbp>=180 | dbp >=120) {
   # return("Hypertensive Crisis")
  #}
if (sbp>=140 | dbp >=90) {
    return("Hypertension Stage 2+")
  }

if ((sbp>=130 & sbp<=139) | (dbp >=80 & dbp <=89)) {
    return("Hypertension Stage 1")
  }

 if ((sbp>=120 & sbp<=129) &  dbp <80) {
    return("Elevated")
  }

  if (sbp < 120 & dbp <80) {
    return("Normal") 
  }
} 
```  


```{r, eval=TRUE}
# Converting Blood pressure into categories
analysis_df$bp_category <- mapply(bp_cat, analysis_df$SBP, analysis_df$DBP)

str(analysis_df$bp_category)
analysis_df$bp_category <- as.factor(analysis_df$bp_category)
analysis_df$bp_category <- relevel(analysis_df$bp_category, "Normal") #this sets "normal" as the reference category.

```

***Regression Models***
Outcome: Fasting glucose - continuous
Use cut-off of 0.20
```{r}
glm_bp <- glm(FastGlucose ~ bp_category, data = analysis_df)
summary(glm_bp) # p<0.001 --> KEEP

glm_age <- glm(FastGlucose ~ AGE, data = analysis_df)
summary(glm_age) # p<0.001 --> KEEP

glm_gender <- glm(FastGlucose ~ GENDER, data = analysis_df)
summary(glm_gender) # p<0.001 --> KEEP

glm_bmi <- glm(FastGlucose ~ BMI_cat, data = analysis_df)
summary(glm_bmi) # p<0.001 --> KEEP

glm_hdl_ldl <- glm(FastGlucose ~ HDL_LDL, data = analysis_df)
summary(glm_hdl_ldl) # p<0.001 --> KEEP
# NOTE: since we are creating a ratio of HDL to LDL, we dont even need to evaluate LDL and HDL alone.

glm_race <- glm(FastGlucose ~ RACE, data = analysis_df)
summary(glm_race) # p=0.207 is the smallest --> can keep but can also drop. let's see what the stepwise does. 

glm_tri <- glm(FastGlucose ~ Triglycerides, data = analysis_df)
summary(glm_tri) # p<0.001 --> KEEP

glm_tot_chol <- glm(FastGlucose ~ Tot_chol, data = analysis_df)
summary(glm_tot_chol) # p<0.039 --> DO NOT KEEP

# **** REMOVE BOTH OF THESE HDL AND LDL MODELS*********
glm_hdl <- glm(FastGlucose ~ HDL, data = analysis_df)
summary(glm_hdl) # p<0.001 --> KEEP

glm_ldl <- glm(FastGlucose ~ LDL, data = analysis_df)
summary(glm_ldl) # p=0.013--> KEEP --> this might drop out

```

***INTERACTION TERMS***
```{r}
analysis_df$age_hdl_ldl <- analysis_df$HDL_LDL * analysis_df$AGE
```



*Full Models*
```{r}
full_model <- glm(FastGlucose ~ BMI_cat + bp_category  + AGE + GENDER +
                    HDL_LDL + RACE + age_hdl_ldl, data = analysis_df)
summary(full_model)
```

Plotting residuals
```{r}
plot(resid(full_model))
```

```{r}
rst <- rstandard(full_model)
qqnorm(rst, ylab = "Standardized Residuals", 
       xlab = "Normal Scores")
qqline(rst)
```

```{r}
analysis_df$cooksd <- cooks.distance(full_model)
cooksd_cutoff <- 4/nrow(analysis_df)

plot(analysis_df$cooksd)
abline(cooksd_cutoff, 0)
```

Dropping outliers
```{r}
analysis_df2 <- analysis_df %>% filter(cooksd < cooksd_cutoff) %>% select(-cooksd)

full_model <- glm(FastGlucose ~ BMI_cat + bp_category  + AGE + GENDER +
                    HDL_LDL + RACE, data = analysis_df2)
summary(full_model)
```

Plotting residuals
```{r}
plot(resid(full_model))
```

```{r}
rst <- rstandard(full_model)
qqnorm(rst, ylab = "Standardized Residuals", 
       xlab = "Normal Scores")
qqline(rst)
```


Cleaning data even further: 
remove:
triglycerides > 500 mg/dl
HDL > 100 mg/dl
Fasting glucose >=126 mg/dl
```{r}
analysis_df <- analysis_df %>% filter(DBP>0 & 
                                        Triglycerides <=500 & HDL <=100 &
                                        FastGlucose <126)
# dropping HDL >100 b/c that high level is actually bad for the heart - genetic issue
#fasting glycose of >=126 mg/dl is considered T2D
nrow(analysis_df)


full_model <- glm(FastGlucose ~ BMI_cat + bp_category  + AGE + GENDER +
                    HDL_LDL + RACE, data = analysis_df2)
summary(full_model)
```

Dropping outliers
```{r}
analysis_df2 <- analysis_df %>% filter(cooksd < cooksd_cutoff) %>% select(-cooksd)

full_model <- glm(FastGlucose ~ BMI_cat + bp_category  + AGE + GENDER +
                    HDL_LDL + RACE, data = analysis_df2)
summary(full_model)
```

```{r}
rst <- rstandard(full_model)
qqnorm(rst, ylab = "Standardized Residuals", 
       xlab = "Normal Scores")
qqline(rst)
```

```{r}
library(MASS)
# Stepwise regression model
step.model <- stepAIC(full_model, direction = "backward", 
                      trace = TRUE )
summary(step.model)
```

```{r}
rst <- rstandard(full_model)
qqnorm(rst, ylab = "Standardized Residuals", 
       xlab = "Normal Scores")
qqline(rst)

library(car)

vif(glm(FastGlucose ~ BMI_cat + bp_category  + AGE + GENDER +
                    HDL_LDL + RACE + Triglycerides + HDL + LDL, data=analysis_df2))
# VIF has to be <=1 ???

pairs(analysis_df2 %>% dplyr::select(AGE,  HDL_LDL))
```

